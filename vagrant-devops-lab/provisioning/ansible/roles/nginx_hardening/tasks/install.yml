---
# ================================
# Nginx Installation (Safe Mode)
# ================================

- name: Ensure Nginx is installed
  apt:
    name: nginx
    state: present
    update_cache: yes
  tags:
    - app
    - nginx

# ================================
# Remove default site
# ================================
- name: Remove default Nginx site symlink
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  tags:
    - app
    - nginx

- name: Remove default Nginx site config
  file:
    path: /etc/nginx/sites-available/default
    state: absent
  tags:
    - app
    - nginx

# ================================
# Deploy our minimal config
# ================================
- name: Deploy safe nginx.conf
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
  notify: Reload nginx
  tags:
    - app
    - nginx