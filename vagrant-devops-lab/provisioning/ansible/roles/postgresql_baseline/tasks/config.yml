# ============================================
# PostgreSQL version & config path discovery
# ============================================

- name: Discover installed PostgreSQL versions
  find:
    paths: /etc/postgresql
    file_type: directory
    depth: 1
  register: postgresql_versions
  tags:
    - db
    - postgresql

- name: Fail if no PostgreSQL version is detected
  fail:
    msg: "No PostgreSQL installation found under /etc/postgresql"
  when: postgresql_versions.matched == 0
  tags:
    - db
    - postgresql

- name: Set PostgreSQL version fact (first detected)
  set_fact:
    pg_version: "{{ postgresql_versions.files | map(attribute='path') | map('basename') | sort | last }}"
  tags:
    - db
    - postgresql

- name: Set PostgreSQL configuration path
  set_fact:
    pg_conf_path: "/etc/postgresql/{{ pg_version }}/main"
  tags:
    - db
    - postgresql

# ============================================
# Network binding (internal only)
# ============================================

- name: Configure PostgreSQL listen addresses (localhost + internal IP)
  lineinfile:
    path: "{{ pg_conf_path }}/postgresql.conf"
    regexp: '^[#\s]*listen_addresses\s*='
    line: "listen_addresses = 'localhost,192.168.56.12'"
    state: present
    backup: yes
  notify: Reload PostgreSQL
  tags:
    - db
    - postgresql

# ============================================
# Client authentication (App server only)
# ============================================

- name: Allow App server access to PostgreSQL
  lineinfile:
    path: "{{ pg_conf_path }}/pg_hba.conf"
    line: "host    all     all     192.168.56.11/32    md5"
    state: present
    insertafter: EOF
    backup: yes
  notify: Reload PostgreSQL
  tags:
    - db
    - postgresql

#- name: Create application DB user
#  postgresql_user:
#    name: "{{ postgresql_app_user }}"
#    password: "{{ postgresql_app_password }}"
#    db: "{{ postgresql_app_db }}"
#    state: present
#  tags:
#    - postgresql
#    - db