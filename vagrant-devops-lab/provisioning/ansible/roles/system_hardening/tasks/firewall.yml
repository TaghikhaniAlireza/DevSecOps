---
# ================================
# Install firewall packages
# ================================
- name: Install iptables persistent
  apt:
    name:
      - iptables
      - iptables-persistent
    state: present
  tags:
    - hardening
    - firewall

# ================================
# Flush rules (BUT KEEP POLICY)
# ================================
- name: Flush existing rules
  iptables:
    flush: yes
  tags:
    - hardening
    - firewall

# ================================
# Allow loopback
# ================================
- name: Allow loopback
  iptables:
    chain: INPUT
    in_interface: lo
    jump: ACCEPT
  tags:
    - hardening
    - firewall

# ================================
# Allow established
# ================================
- name: Allow ESTABLISHED,RELATED
  iptables:
    chain: INPUT
    ctstate: ESTABLISHED,RELATED
    jump: ACCEPT
  tags:
    - hardening
    - firewall

# ================================
# Allow SSH (CRITICAL)
# ================================
- name: Allow SSH
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 22
    jump: ACCEPT
  tags:
    - hardening
    - firewall

# ================================
# App node rules
# ================================
- name: Allow HTTP on App
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "80"
    jump: ACCEPT
  when: inventory_hostname in groups['app']
  tags:
    - hardening
    - firewall

# ================================
# DB node rules
# ================================
- name: Allow PostgreSQL from App only
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "5432"
    source: 192.168.56.11
    jump: ACCEPT
  when: inventory_hostname in groups['db']
  tags:
    - hardening
    - firewall

# ================================
# NOW enforce default DROP
# ================================
- name: Set default INPUT policy DROP
  iptables:
    chain: INPUT
    policy: DROP
  tags:
    - hardening
    - firewall

- name: Set default FORWARD policy DROP
  iptables:
    chain: FORWARD
    policy: DROP
  tags:
    - hardening
    - firewall

- name: Set default OUTPUT policy ACCEPT
  iptables:
    chain: OUTPUT
    policy: ACCEPT
  tags:
    - hardening
    - firewall

# ================================
# Persist rules
# ================================
- name: Save iptables rules
  command: netfilter-persistent save
  tags:
    - hardening
    - firewall
